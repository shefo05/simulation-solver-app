<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dependency Test (Autocorrelation)</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* --- تنسيقات الشبكة 10*10 --- */
        .method-selector { margin-bottom: 15px; padding: 20px; background: #eef2f5; border-radius: 8px; border-left: 5px solid #2c3e50; }
        .method-options { display: none; margin-top: 15px; padding: 15px; border: 1px solid #ddd; background: #fff; border-radius: 5px; }
        .active-method { display: block; }
        
        .rnd-grid {
            display: grid; grid-template-columns: repeat(10, 1fr); gap: 8px;
            border: 1px solid #ccc; padding: 15px; background: #fdfdfd; border-radius: 5px;
        }
        
        .rnd-cell {
            padding: 10px 2px; background: #fff; border: 1px solid #e0e0e0;
            text-align: center; cursor: pointer; font-size: 14px;
            font-family: 'Segoe UI', Tahoma, monospace; color: #333;
            border-radius: 4px; font-weight: 600;
            transition: all 0.2s ease; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .rnd-cell:hover { background-color: #3498db; color: white; transform: scale(1.15); z-index: 10; }
        .rnd-cell:active { background-color: #27ae60; transform: scale(1); }

        /* --- تنسيق الجداول والخطوات --- */
        .lecture-table { width: 100%; border-collapse: collapse; margin-top: 10px; margin-bottom: 20px; font-size: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .lecture-table th { background-color: #2c3e50; color: white; padding: 12px; border: 1px solid #2c3e50; font-family: 'Times New Roman', serif; font-size: 1.1em; }
        .lecture-table td { padding: 8px; border: 1px solid #ddd; text-align: center; }
        .lecture-table tr:nth-child(even) { background-color: #f8f9fa; }
        .lecture-table tfoot { font-weight: bold; background-color: #eaf2f8; }

        /* صندوق القوانين الأصفر */
        .formula-box {
            background-color: #fff3cd; color: #856404; padding: 15px; 
            border: 1px solid #ffeeba; border-radius: 5px; margin-bottom: 15px;
            font-family: 'Times New Roman', serif; font-size: 1.3em; text-align: center;
            line-height: 1.6;
        }
        
        h3 { border-bottom: 2px solid #3498db; padding-bottom: 5px; color: #2c3e50; margin-top: 30px; font-family: 'Segoe UI', sans-serif; }
        
        .tab-btn {
            background: #eee; border: 1px solid #ccc; padding: 8px 20px; cursor: pointer; margin-right: 5px; border-radius: 4px 4px 0 0; font-weight: bold;
        }
        .tab-btn.active { background: #3498db; color: white; border-color: #3498db; }

        .final-result-box {
            background-color: #fff; border: 2px solid #27ae60; padding: 20px; 
            border-radius: 8px; text-align: center; margin-top: 20px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        /* تحسين شكل الرموز الرياضية */
        .math { font-family: 'Times New Roman', serif; font-style: italic; }
        .xbar { text-decoration: overline; }
    </style>
</head>
<body>

<div class="navbar">
    <a href="index.html">LCG</a>
    <a href="midsquare.html">Mid-Sq</a>
    <a href="single_server.html">Single</a>
    <a href="multi_server.html">Multi</a>
    <a href="inventory.html">Inventory</a>
    <a href="queuing_calc.html">Calc</a>
    <a href="testing.html">KS-Test</a>
    <a href="autocorrelation.html" class="active">Independence</a>
</div>

<div class="container">
    <h1>Tests for Random Numbers: Dependency</h1>
    <div class="note">
        <strong>Goal:</strong> Test Independence using Autocorrelation method.
        <br>Follows Chapter 6 (Slides 20-29).
    </div>

    <div class="input-section">
        <div class="method-selector">
            <label style="font-weight:bold; font-size:1.1em;">Input Random Numbers:</label>
            <select id="inputMethod" onchange="switchInput()" style="padding: 8px; border-radius: 4px; margin-left:10px;">
                <option value="manual">Manual Input (Paste)</option>
                <option value="table" selected>Random Table (Click)</option>
            </select>

            <div id="manual_input" class="method-options">
                <textarea id="rnInput" rows="4" style="width:98%; font-size:16px; padding:10px;" placeholder="e.g. 0.44, 0.81, 0.14, 0.05, 0.93..."></textarea>
            </div>

            <div id="table_input" class="method-options active-method">
                <p style="font-size:14px; color:#555; margin-bottom:10px;">Click numbers to add to list:</p>
                <div class="rnd-grid" id="rndGrid"></div>
                <div style="margin-top:10px;">
                    <strong>Selected:</strong>
                    <textarea id="rnInputTable" rows="2" style="width:98%; font-size:14px; background:#eee;" readonly></textarea>
                </div>
            </div>
        </div>
    </div>

    <div style="text-align: center; margin-bottom: 30px;">
        <button class="solve-btn" onclick="runAutocorrelation()">CALCULATE</button>
    </div>

    <div id="resultArea" style="display:none;">
        
        <h3>Step 1: Calculate Statistics</h3>
        <div class="formula-box">
            Mean (<span class="xbar">x</span>) = &sum; x<sub>i</sub> / N <br>
            Variance (S<sup>2</sup><sub>x</sub>) = &sum; (x<sub>i</sub> - <span class="xbar">x</span>)<sup>2</sup> / (N - 1)
        </div>
        <p style="font-size:1.1em; text-align:center;">
            <strong>N = </strong> <span id="res_N"></span> &nbsp;|&nbsp; 
            <strong><span class="xbar">x</span> = </strong> <span id="res_mean" style="color:blue; font-weight:bold;"></span> &nbsp;|&nbsp; 
            <strong>S<sup>2</sup><sub>x</sub> = </strong> <span id="res_var" style="color:red; font-weight:bold;"></span>
        </p>

        <table class="lecture-table" id="devTable">
            <thead>
                <tr>
                    <th>i</th>
                    <th>x<sub>i</sub></th>
                    <th>x<sub>i</sub> - <span class="xbar">x</span></th>
                    <th>(x<sub>i</sub> - <span class="xbar">x</span>)<sup>2</sup></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <h3>Step 2: Detailed Calculation</h3>
        <p>Select a value for <strong>k</strong> (shift) to see the calculation details:</p>
        <div id="kTabs" style="margin-bottom:10px;"></div>
        
        <div class="formula-box">
            r<sub>xx</sub>(k) = [ &sum; (x<sub>i</sub> - <span class="xbar">x</span>)(x<sub>i+k</sub> - <span class="xbar">x</span>) ] / [ (N - k) &times; S<sup>2</sup><sub>x</sub> ]
        </div>
        
        <table class="lecture-table" id="calcTable">
            <thead>
                <tr>
                    <th>i</th>
                    <th>x<sub>i</sub></th>
                    <th>x<sub>i+k</sub></th>
                    <th>(x<sub>i</sub> - <span class="xbar">x</span>)</th>
                    <th>(x<sub>i+k</sub> - <span class="xbar">x</span>)</th>
                    <th>Product</th>
                </tr>
            </thead>
            <tbody></tbody>
            <tfoot id="calcFooter"></tfoot>
        </table>

        <h3>Step 3: Summary Table</h3>
        <p>Correlation Coefficient r<sub>xx</sub>(k) for different values of k:</p>
        <table class="lecture-table" id="summaryTable" style="width:60%; margin:auto;">
            <thead>
                <tr>
                    <th>k</th>
                    <th>r<sub>xx</sub>(k)</th>
                    <th>|r<sub>xx</sub>(k)|</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <h3>Step 4: Conclusion</h3>
        <div class="final-result-box">
            <p style="font-size:1.1em;">Compute Average of Absolute Correlations:</p>
            <div style="font-size:1.4em; margin: 10px 0;">
                Avg = <span id="final_avg" style="color:#d35400; font-weight:bold;"></span>
            </div>
            <div id="final_verdict" style="font-size:1.3em; font-weight:bold; margin-top:10px; color:#27ae60;"></div>
            <p style="font-size:0.95em; color:#555; margin-top:10px;">
                * If the value is close to zero, it indicates <strong>Independence</strong>.<br>
                * If close to 1, it indicates <strong>Dependence</strong>.
            </p>
        </div>
    </div>
</div>

<script>
    // --- Init ---
    let selectedNumbers = [];
    window.onload = function() {
        fillRandomGrid();
    };

    function switchInput() {
        let val = document.getElementById('inputMethod').value;
        document.getElementById('manual_input').style.display = (val === 'manual') ? 'block' : 'none';
        document.getElementById('table_input').style.display = (val === 'table') ? 'block' : 'none';
    }

    function fillRandomGrid() {
        let container = document.getElementById('rndGrid');
        let html = '';
        for(let i=0; i<100; i++) {
            let num = Math.random().toFixed(2);
            html += `<div class="rnd-cell" onclick="addNumber('${num}')">${num}</div>`;
        }
        container.innerHTML = html;
    }

    function addNumber(num) {
        selectedNumbers.push(num);
        document.getElementById('rnInputTable').value = selectedNumbers.join(', ');
        document.getElementById('rnInput').value = selectedNumbers.join(', '); 
    }

    // --- LOGIC ---
    let globalR = [];
    let globalMean = 0;
    let globalVar = 0;
    let globalN = 0;

    function runAutocorrelation() {
        // 1. Get Inputs
        let rawInput = document.getElementById('inputMethod').value === 'manual' 
            ? document.getElementById('rnInput').value 
            : document.getElementById('rnInputTable').value;
        
        let R = rawInput.split(/[\s,]+/).map(x => parseFloat(x.trim())).filter(x => !isNaN(x));
        globalN = R.length;
        globalR = R;

        if (globalN < 3) { alert("Please enter at least 3 numbers."); return; }

        // 2. Statistics (Mean & Variance)
        let sum = R.reduce((a, b) => a + b, 0);
        globalMean = sum / globalN;
        
        let sumSqDiff = 0;
        let devTableHtml = "";
        
        for(let i=0; i<globalN; i++) {
            let diff = R[i] - globalMean;
            let diffSq = diff * diff;
            sumSqDiff += diffSq;
            devTableHtml += `<tr>
                <td>${i+1}</td>
                <td>${R[i]}</td>
                <td>${diff.toFixed(4)}</td>
                <td>${diffSq.toFixed(4)}</td>
            </tr>`;
        }
        
        globalVar = sumSqDiff / (globalN - 1); 
        
        document.getElementById('resultArea').style.display = 'block';
        document.getElementById('res_N').innerText = globalN;
        document.getElementById('res_mean').innerText = globalMean.toFixed(4);
        document.getElementById('res_var').innerText = globalVar.toFixed(5);
        document.getElementById('devTable').getElementsByTagName('tbody')[0].innerHTML = devTableHtml;

        // 3. Loop for all possible k (1 to N-1, capped at 10)
        let maxK = Math.min(globalN - 1, 10); 
        let summaryHtml = "";
        let sumAbsR = 0;
        let tabsHtml = "";

        for(let k=1; k<=maxK; k++) {
            let r = calculateR(k);
            let absR = Math.abs(r);
            sumAbsR += absR;
            
            summaryHtml += `<tr>
                <td>${k}</td>
                <td style="font-weight:bold; color:${r>=0?'blue':'red'}">${r.toFixed(5)}</td>
                <td>${absR.toFixed(5)}</td>
            </tr>`;

            tabsHtml += `<button class="tab-btn ${k===1?'active':''}" onclick="showDetail(${k}, this)">k=${k}</button>`;
        }

        document.getElementById('summaryTable').getElementsByTagName('tbody')[0].innerHTML = summaryHtml;
        document.getElementById('kTabs').innerHTML = tabsHtml;
        
        // 4. Final Conclusion
        let avgAbs = sumAbsR / maxK;
        document.getElementById('final_avg').innerText = avgAbs.toFixed(5);
        
        let conclusion = "";
        if (avgAbs < 0.25) {
            conclusion = "Conclusion: INDEPENDENCE (Small Value)";
            document.getElementById('final_verdict').style.color = "green";
        } else {
            conclusion = "Conclusion: DEPENDENCE (Large Value)";
            document.getElementById('final_verdict').style.color = "#c0392b";
        }
        document.getElementById('final_verdict').innerText = conclusion;

        // Show default detail for k=1
        showDetail(1, document.querySelector('.tab-btn')); 
    }

    function calculateR(k) {
        let numeratorSum = 0;
        for(let i=0; i < globalN - k; i++) {
            let term1 = globalR[i] - globalMean;
            let term2 = globalR[i+k] - globalMean;
            numeratorSum += term1 * term2;
        }
        // القانون كما في المحاضرة: البسط / ( (N-k) * التباين )
        return numeratorSum / ((globalN - k) * globalVar);
    }

    window.showDetail = function(k, btn) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');

        let tbody = document.querySelector('#calcTable tbody');
        let html = "";
        let numeratorSum = 0;

        for(let i=0; i < globalN - k; i++) {
            let val1 = globalR[i];
            let val2 = globalR[i+k];
            let term1 = val1 - globalMean;
            let term2 = val2 - globalMean;
            let product = term1 * term2;
            numeratorSum += product;

            html += `<tr>
                <td>${i+1}</td>
                <td>${val1}</td>
                <td>${val2}</td>
                <td>${term1.toFixed(4)}</td>
                <td>${term2.toFixed(4)}</td>
                <td>${product.toFixed(5)}</td>
            </tr>`;
        }
        tbody.innerHTML = html;

        let r_xx = numeratorSum / ((globalN - k) * globalVar);
        let denominator = (globalN - k) * globalVar;

        let footerHtml = `
            <tr style="background:#fff3cd;">
                <td colspan="5" style="text-align:right; font-weight:bold;">Sum of Products (Numerator):</td>
                <td style="font-weight:bold;">${numeratorSum.toFixed(5)}</td>
            </tr>
            <tr style="background:#eafaf1;">
                <td colspan="5" style="text-align:right;">
                    <strong>r<sub>xx</sub>(${k})</strong> = ${numeratorSum.toFixed(5)} / [ (${globalN}-${k}) &times; ${globalVar.toFixed(5)} ] = 
                </td>
                <td style="color:blue; font-size:1.2em;"><strong>${r_xx.toFixed(5)}</strong></td>
            </tr>
        `;
        document.getElementById('calcFooter').innerHTML = footerHtml;
    }
</script>

</body>
</html>